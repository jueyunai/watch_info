# 观猹个人猹评获取工具 (Watcha Reviews Exporter) 项目说明文档

> **版本**：v2.0（年度报告版）  
> **最后更新**：2025-12-30

---

## 1. 项目简介

**观猹个人猹评获取工具** 是一个专为 [观猹 (Watcha)](https://watcha.cn) 用户设计的实用工具。旨在帮助用户轻松导出自己在观猹平台上的所有评论（猹评）和讨论帖子，并结合 AI 生成深度洞察报告。

**最新核心功能**：2025年度报告生成器——用户输入个人主页即可自动获取全年数据，生成精美可视化报告 + AI深度洞察，支持下载竖屏海报分享。

本项目采用 **前后端分离** 架构，前端提供简洁的交互界面，后端（通过 Vercel Serverless）处理跨域请求和LLM API调用。

---

## 2. 核心功能

### 2.1 🎉 年度报告生成器（NEW）

**入口**：`/annual.html`

| 功能 | 说明 |
|------|------|
| **一键生成** | 输入观猹个人主页链接，自动获取2025全年数据 |
| **可视化统计** | 猹评数、讨论数、产品数、活跃天数、字数、月度曲线 |
| **动态徽章** | 根据活跃度自动颁发等级徽章（见下方详细规则） |
| **成就标签** | 自动识别用户特征并生成成就标签 |
| **AI 洞察** | 调用 LLM API 生成深度年度分析 |
| **海报分享** | 使用 html2canvas 渲染竖屏海报，支持下载或长按保存 |

#### 徽章等级规则

| 等级 | 英文名 | 触发条件 |
|------|--------|----------|
| Level 4 | Legend（传奇） | 猹评数 ≥ 200 **或** 活跃天数 ≥ 200 |
| Level 3 | Philosopher（思想家） | 猹评数 ≥ 50 **或** (猹评数 > 5 且 平均字数 ≥ 500) |
| Level 2 | Analyst（分析师） | 猹评数 ≥ 10 **或** 活跃天数 ≥ 30 |
| Level 1 | Observer（观察者） | 默认等级 |

徽章图片位于 `public/badges/` 目录：
- `badge_observer.png`
- `badge_analyst.png`
- `badge_philosopher.png`
- `badge_legend.png`

### 2.2 数据获取与导出

- **猹评导出**：支持获取指定用户的所有"猹评"数据
- **讨论导出**：支持获取指定用户的所有"讨论"（帖子）数据
- **智能去重**：自动处理 API 分页可能带来的重复数据
- **格式化导出**：将获取的数据格式化为易读的 TXT 文本

### 2.3 AI 辅助分析

- **LLM 集成**：支持多厂商 LLM API（OpenAI、Anthropic、Google、SiliconFlow、Zhipu 等）
- **模型优先级**：支持配置模型优先级，自动切换备用模型
- **年报配方**：内置经过优化的 AI 提示词（年度认知审计师角色）

---

## 3. 技术架构

### 3.1 技术栈

| 层级 | 技术 |
|------|------|
| 前端核心 | HTML5, CSS3, TypeScript (Vanilla) |
| 构建工具 | Vite |
| 后端/代理 | Vercel Serverless Functions (Node.js) |
| LLM 集成 | 多厂商适配（OpenAI/Claude/Gemini/DeepSeek 等） |
| 海报生成 | html2canvas |
| 部署平台 | Vercel |

### 3.2 项目结构

```
watcha-reviews-exporter/
├── api/                        # Vercel Serverless Functions
│   ├── proxy.ts                # 观猹 API 代理
│   └── llm.ts                  # LLM API 代理
├── public/
│   ├── badges/                 # 徽章图片
│   │   ├── badge_observer.png
│   │   ├── badge_analyst.png
│   │   ├── badge_philosopher.png
│   │   └── badge_legend.png
│   ├── textures/               # 海报纹理图片
│   └── qrcode*.png             # 分享二维码
├── src/
│   ├── annual.ts               # 年度报告主逻辑
│   ├── annual.css              # 年度报告样式（1900+ 行）
│   ├── main.ts                 # 原版导出工具逻辑
│   ├── style.css               # 原版导出工具样式
│   ├── config/
│   │   └── llm.ts              # LLM 配置（厂商优先级）
│   ├── services/
│   │   ├── api.ts              # 观猹 API 调用
│   │   └── llm.ts              # LLM 服务层
│   ├── types/
│   │   ├── annual.ts           # 年报类型定义
│   │   └── index.ts            # 通用类型定义
│   └── utils/
│       ├── annualAnalyzer.ts   # 年度数据分析
│       ├── dataSummarizer.ts   # LLM 数据格式化
│       ├── reviewProcessor.ts  # 数据处理
│       └── urlParser.ts        # URL 解析
├── doc/                        # 进展文档
├── history/                    # 历史版本存档
├── annual.html                 # 年度报告入口页
├── index.html                  # 导出工具入口页
└── 项目说明文档.md
```

### 3.3 关键模块说明

| 模块 | 文件 | 功能 |
|------|------|------|
| 徽章等级 | `src/annual.ts` (L241-256) | `getBadgeLevel()` 函数根据统计数据返回等级 |
| 成就标签 | `src/utils/annualAnalyzer.ts` | `generateLabels()` 生成动态成就 |
| AI 洞察 | `src/annual.ts` (L598-706) | `generateAIInsight()` 调用 LLM 并渲染结果 |
| 海报生成 | `src/annual.ts` (L478-528) | `downloadPoster()` 使用 html2canvas |
| 样式系统 | `src/annual.css` | 完整的 V7 版设计系统，包含响应式和海报模式 |

---

## 4. 部署与环境

### 4.1 环境变量

在 `.env` 或 Vercel 环境变量中配置：

```env
# LLM API Keys（根据使用的厂商配置）
OPENAI_API_KEY=
ANTHROPIC_API_KEY=
GOOGLE_API_KEY=
SILICONFLOW_API_KEY=
ZHIPU_API_KEY=
...

# 可选：模型优先级
VITE_LLM_PROVIDER_PRIORITY=siliconflow,zhipu,openai

# 开发环境可选
VITE_USE_MOCK=true  # 使用模拟数据
```

### 4.2 本地开发

```bash
npm install       # 安装依赖
npm run dev       # 启动开发服务器 (http://localhost:5173)
```

访问入口：
- 年度报告：`http://localhost:5173/annual.html`
- 导出工具：`http://localhost:5173/`

### 4.3 生产环境部署

本项目针对 **Vercel** 进行了优化：
- 自动识别 Vite 项目进行构建
- `api/` 目录自动部署为 Serverless Functions
- 推送到 GitHub 后自动触发 Vercel 部署

---

## 5. 开发历史与更新日志

### 🎉 重大更新：2025年度报告生成器 (2025-12-26 ~ 2025-12-30)

**策划**：基于《观猹2025年度报告_融合版策划案.md》

| 日期 | 里程碑 |
|------|--------|
| 12-26 | 策划案完成，技术方案确定 |
| 12-27 | 数据分析逻辑 + 基础 UI |
| 12-28 | 报告页面迭代至 V7 版本 |
| 12-29 | AI 洞察集成 + 徽章系统 |
| 12-30 | 微信海报兼容修复，多模型支持 |

### 🐛 问题修复

#### 微信海报生成问题 (2025-12-30)

**问题**：微信内置浏览器中 `html2canvas` 报错 `Failed to execute 'createPattern'`

**原因**：复杂的 CSS 渐变（`repeating-linear-gradient`、`radial-gradient`）在微信 WebView 中无法正确渲染

**解决方案**：
- 预渲染纹理图片替代 CSS 渐变
- 新增 `poster-mode` 样式类，在海报模式下使用静态图片
- 纹理文件位于 `public/textures/`

详见：`doc/微信海报生成问题修复.md`

#### 其他修复

- **Fix: CORS Issue** (2025-12-01) - Vercel Serverless 代理
- **Fix: Infinite Loop** (2025-12-01) - API 错误处理
- **Fix: Duplicate Reviews** (2025-12-01) - 数据去重
- **Fix: URL Encoding** (2025-12-01) - 中文用户名编码

---

## 6. 使用指南

### 6.1 生成年度报告

1. 访问 `/annual.html`
2. 输入观猹个人主页链接（如 `https://watcha.cn/@用户名`）
3. 点击「生成我的年度报告」
4. 等待数据获取完成（约 30-90 秒）
5. 查看可视化报告
6. 点击「✨ 生成 AI 洞察」获取 AI 分析
7. 点击「分享海报」生成并下载竖屏海报

### 6.2 导出原始数据

1. 访问 `/`
2. 输入观猹个人主页链接
3. 勾选"猹评"或"讨论"
4. 点击「获取数据」
5. 选择特定月份（可选）
6. 点击「导出 TXT」下载

---

## 7. 后续迭代方向

- [ ] 2024 vs 2025 年度对比功能
- [ ] 时间胶囊（年初预测 → 年末验证）
- [ ] 社区排行榜
- [ ] 更多 LLM 厂商支持
- [ ] 海报模板多样化

---

*项目维护者：志云*  
*致谢：神奇小喷菇AIGC, 认知少女*

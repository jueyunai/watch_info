# 微信海报生成问题修复报告

## 问题概述

**问题现象**：在微信内置浏览器中打开观猹年度报告页面，点击「分享海报」按钮时报错：
```
生成海报失败: Failed to execute 'createPattern' on 'CanvasRenderingContext2D': 
The image argument is a canvas element with a width or height of 0.
```

**问题原因**：`html2canvas` 库在渲染复杂的 CSS 背景（如 `repeating-linear-gradient`、`radial-gradient` 组合）时，会创建内部 canvas 来生成可平铺的图案。在微信 WebView 中，某些情况下这个内部 canvas 的宽高会变成 0，导致 `ctx.createPattern()` 调用失败。

## 解决方案

采用**预渲染纹理图片**方案：将复杂的 CSS 渐变效果预先渲染成 PNG 图片，在 `poster-mode` 下用这些图片替代 CSS 渐变。

### 生成的纹理文件

| 文件名 | 尺寸 | 用途 |
|--------|------|------|
| `noise-texture.png` | 120×120 | 替代 `body::after` 的 SVG 噪点纹理 |
| `grid-texture.png` | 54×54 | 替代 `body.annual-v7::after` 的网格线背景 |
| `finale-qr-bg.png` | 400×300 | 替代 `.finale-qr::after` 的渐变 + 斜线纹理 |
| `cover-glow.png` | 600×400 | 替代 `.cover-section::after` 的高光效果 |
| `diagonal-lines.png` | 14×14 | 备用斜线纹理（可平铺） |

### 修改的文件

1. **`src/annual.css`** (第 1576-1608 行)
   - 新增 `poster-mode` 下使用预渲染纹理的样式规则

2. **新增文件**：
   - `public/textures/` - 纹理图片目录
   - `generate-textures.ts` - 纹理生成脚本（Node.js + canvas）
   - `generate-textures.html` - 浏览器端纹理生成工具（备用）

### CSS 修改详情

```css
/* Poster Mode: 使用预渲染纹理替代复杂 CSS 渐变 */

/* 替代 body::after 噪点纹理 */
body.poster-mode::after {
  background-image: url('/textures/noise-texture.png') !important;
  background-repeat: repeat !important;
  background-size: 120px 120px !important;
}

/* 替代 body.annual-v7::after 网格纹理 */
body.annual-v7.poster-mode::after {
  background-image: url('/textures/grid-texture.png') !important;
  background-repeat: repeat !important;
  background-size: 54px 54px !important;
}

/* 替代 .finale-qr::after 渐变背景 */
body.poster-mode .finale-qr::after,
body.annual-v7.poster-mode .finale-qr::after {
  background: url('/textures/finale-qr-bg.png') center/cover no-repeat !important;
  opacity: 0.32;
}

/* 替代 .cover-section::after 高光效果 */
body.poster-mode .cover-section::after,
body.annual-v7.poster-mode .cover-section::after {
  background: url('/textures/cover-glow.png') center/cover no-repeat !important;
  opacity: 0.8;
}
```

## 验证状态

- [x] 纹理图片生成成功
- [x] 本地开发服务器纹理加载正常（HTTP 200）
- [ ] 微信环境实际测试（需部署后验证）

## 后续步骤

1. 将代码推送到 GitHub，触发 Vercel 部署
2. 在微信中测试海报生成功能
3. 如仍有问题，可考虑：
   - 增加更多 `poster-mode` 样式覆盖
   - 在 `onclone` 回调中进一步处理

---

**修复日期**：2025-12-30  
**修复版本**：待提交

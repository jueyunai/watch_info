# é¡¹ç›®å®‰å…¨åˆ†ææŠ¥å‘Š

> **åˆ†ææ—¥æœŸ**ï¼š2025-12-30  
> **æœ€åæ›´æ–°**ï¼š2025-12-30  
> **é¡¹ç›®**ï¼šè§‚çŒ¹ä¸ªäººçŒ¹è¯„è·å–å·¥å…· (Watcha Reviews Exporter)

---

## ğŸ“‹ æ€»ä½“è¯„ä¼°

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **LLM å®‰å…¨** | âœ… å·²ä¿®å¤ | å·²æ·»åŠ  Origin + Referer åŒé‡éªŒè¯ |
| **API ä»£ç†å®‰å…¨** | âœ… å·²ä¿®å¤ | å·²æ·»åŠ æ¥æºéªŒè¯ + è·¯å¾„ç™½åå• |
| **æ•°æ®æ³„éœ²é£é™©** | âœ… ä½é£é™© | æœ¬åœ°å­˜å‚¨è®¾è®¡åˆç† |
| **ä»£ç è´¨é‡** | âœ… è‰¯å¥½ | æ¶æ„æ¸…æ™°ï¼Œå¯ç»´æŠ¤æ€§å¥½ |

---

## ğŸ”´ é«˜ä¼˜å…ˆçº§å®‰å…¨é—®é¢˜

### 1. LLM API ä»£ç†æ— è®¿é—®é™åˆ¶ï¼ˆè¢«æ»¥ç”¨/åä»£é£é™©ï¼‰

**é—®é¢˜ä½ç½®**ï¼š`api/llm.ts`

**é£é™©æè¿°**ï¼š
- å½“å‰ LLM ä»£ç†ç«¯ç‚¹ `/api/llm` æ˜¯**å®Œå…¨å¼€æ”¾çš„å…¬å…± API**
- ä»»ä½•äººéƒ½å¯ä»¥ç›´æ¥è°ƒç”¨è¯¥ç«¯ç‚¹ï¼Œæ¶ˆè€—ä½ çš„ API é…é¢
- CORS è®¾ç½®ä¸º `Access-Control-Allow-Origin: '*'`ï¼Œå…è®¸æ‰€æœ‰æ¥æº
- æ”»å‡»è€…å¯ä»¥å°†ä½ çš„æœåŠ¡ä½œä¸ºå…è´¹ LLM åä»£ä½¿ç”¨

**ä»£ç è¯æ®**ï¼š
```typescript
// api/llm.ts:83-86
res.setHeader('Access-Control-Allow-Origin', '*');  // ğŸš¨ å…è®¸æ‰€æœ‰æ¥æº
res.setHeader('Access-Control-Allow-Methods', 'POST,OPTIONS');
```

**æ”»å‡»åœºæ™¯**ï¼š
1. æ¶æ„ç”¨æˆ·ç›´æ¥å‘é€ curl è¯·æ±‚åˆ° `https://ä½ çš„åŸŸå.vercel.app/api/llm`
2. ä½¿ç”¨ä½ çš„ API Key è°ƒç”¨ LLMï¼ˆminimax/zhipu/deepseek ç­‰ï¼‰
3. ä½ æ‰¿æ‹…æ‰€æœ‰è´¹ç”¨

**ä¿®å¤å»ºè®®**ï¼š

```typescript
// api/llm.ts
export default async function handler(req: VercelRequest, res: VercelResponse) {
  // ğŸ”’ é™åˆ¶å…è®¸çš„ Origin
  const allowedOrigins = [
    'https://ä½ çš„æ­£å¼åŸŸå.vercel.app',
    'http://localhost:5173', // å¼€å‘ç¯å¢ƒ
  ];
  const origin = req.headers.origin || '';
  if (allowedOrigins.includes(origin)) {
    res.setHeader('Access-Control-Allow-Origin', origin);
  }
  
  // ğŸ”’ æ·»åŠ  Referer æ£€æŸ¥
  const referer = req.headers.referer || '';
  if (!allowedOrigins.some(o => referer.startsWith(o))) {
    return res.status(403).json({ error: 'Forbidden' });
  }
  
  // ğŸ”’ å¯é€‰ï¼šæ·»åŠ é€Ÿç‡é™åˆ¶
  // å¯ä»¥ä½¿ç”¨ @vercel/kv æˆ– upstash å®ç°
  
  // ... åŸæœ‰é€»è¾‘
}
```

### 2. Watcha API ä»£ç†åŒæ ·æ— é™åˆ¶

**é—®é¢˜ä½ç½®**ï¼š`api/proxy.ts`

**é£é™©æè¿°**ï¼š
- `/api/proxy` ç«¯ç‚¹å…è®¸ä»£ç†è®¿é—® `watcha.cn/api/v2/*` ä»»æ„è·¯å¾„
- è™½ç„¶ Watcha API æœ¬èº«æ˜¯å…¬å¼€çš„ï¼Œä½†ä½ çš„ä»£ç†å¯èƒ½è¢«æ»¥ç”¨ä½œä¸ºï¼š
  - åŒ¿åæŠ“å–å·¥å…·ï¼ˆéšè—çœŸå® IPï¼‰
  - ç»•è¿‡ Watcha å¯èƒ½çš„ IP é™åˆ¶

**ä»£ç è¯æ®**ï¼š
```typescript
// api/proxy.ts:26
const url = `https://watcha.cn/api/v2/${path}`;  // å¯ä»£ç†ä»»æ„è·¯å¾„
```

**ä¿®å¤å»ºè®®**ï¼š
```typescript
// api/proxy.ts
// ğŸ”’ é™åˆ¶å…è®¸ä»£ç†çš„è·¯å¾„æ ¼å¼
const allowedPathPatterns = [
  /^users\/\d+\/reviews/,
  /^users\/\d+\/posts/,
  /^users\/[^\/]+$/,  // ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢
];

if (!allowedPathPatterns.some(p => p.test(path))) {
  return res.status(400).json({ error: 'Invalid path' });
}
```

---

## ğŸŸ¡ ä¸­ä¼˜å…ˆçº§å®‰å…¨é—®é¢˜

### 3. API Key æš´éœ²é£é™©ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

**é—®é¢˜ä½ç½®**ï¼š`src/config/llm.ts`, `src/services/llm.ts`

**é£é™©æè¿°**ï¼š
- å¼€å‘æ¨¡å¼ä¸‹ï¼Œå‰ç«¯ç›´æ¥ä½¿ç”¨ `import.meta.env.VITE_*_API_KEY` è°ƒç”¨ LLM
- å¦‚æœæ„å»ºæ—¶ `DEV=true` æˆ–é”™è¯¯é…ç½®ï¼ŒAPI Key å¯èƒ½è¢«æ‰“åŒ…åˆ°å‰ç«¯ bundle

**ä»£ç è¯æ®**ï¼š
```typescript
// src/services/llm.ts:61-66
const response = await fetch(buildUrl(config), {
  headers: {
    'Authorization': `Bearer ${config.apiKey}`,  // ğŸš¨ å‰ç«¯æºå¸¦ API Key
  },
});
```

**å½“å‰çŠ¶æ€**ï¼šç”Ÿäº§ç¯å¢ƒä¸‹èµ°åç«¯ä»£ç† `/api/llm`ï¼Œä¸æš´éœ² Keyï¼Œ**è®¾è®¡åˆç†**ã€‚

**æ”¹è¿›å»ºè®®**ï¼š
```typescript
// src/services/llm.ts
// åœ¨ chat å‡½æ•°å¼€å¤´å¢åŠ æ£€æŸ¥
if (!import.meta.env.DEV) {
  throw new Error('ç”Ÿäº§ç¯å¢ƒåº”é€šè¿‡ /api/llm è°ƒç”¨');
}
```

### 4. ç¼ºå°‘è¾“å…¥éªŒè¯

**é—®é¢˜ä½ç½®**ï¼š`api/llm.ts`

**é£é™©æè¿°**ï¼š
- `messages` å‚æ•°åªæ£€æŸ¥æ˜¯å¦ä¸ºæ•°ç»„ï¼ŒæœªéªŒè¯å†…å®¹ç»“æ„
- `provider` å‚æ•°ç›´æ¥ä½¿ç”¨ï¼ŒæœªéªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆæšä¸¾å€¼

**ä¿®å¤å»ºè®®**ï¼š
```typescript
// api/llm.ts
const validProviders: LLMProvider[] = ['minimax', 'zhipu', 'deepseek', 'qwen', 'openai'];

// éªŒè¯ provider
if (requestedProvider && !validProviders.includes(requestedProvider)) {
  return res.status(400).json({ error: 'Invalid provider' });
}

// éªŒè¯ messages ç»“æ„
if (!messages.every(m => m.role && m.content && typeof m.content === 'string')) {
  return res.status(400).json({ error: 'Invalid message format' });
}

// ğŸ”’ é™åˆ¶æ¶ˆæ¯é•¿åº¦
const totalLength = messages.reduce((sum, m) => sum + m.content.length, 0);
if (totalLength > 50000) {  // ä¾‹å¦‚ 50KB é™åˆ¶
  return res.status(400).json({ error: 'Message too long' });
}
```

---

## ğŸŸ¢ ä½ä¼˜å…ˆçº§ / ä¼˜åŒ–å»ºè®®

### 5. æœ¬åœ°å­˜å‚¨æ•æ„Ÿä¿¡æ¯

**é—®é¢˜ä½ç½®**ï¼š`src/annual.ts`

**è¯´æ˜**ï¼š
- ç”¨æˆ·æ•°æ®ç¼“å­˜åœ¨ `localStorage`ï¼ˆ`watcha-annual-data-username`ï¼‰
- AI æ´å¯Ÿç¼“å­˜åœ¨ `localStorage`ï¼ˆ`watcha-ai-insight-username`ï¼‰
- è¿™æ˜¯ç”¨æˆ·è‡ªå·±çš„æ•°æ®ï¼Œå­˜å‚¨åœ¨å®¢æˆ·ç«¯ï¼Œ**é£é™©å¯æ¥å—**

**ä½†å¯ä»¥æ”¹è¿›**ï¼š
```typescript
// æ·»åŠ ç¼“å­˜è¿‡æœŸæœºåˆ¶
function cacheUserData(username: string, data: ...) {
  const cacheEntry = {
    timestamp: Date.now(),
    data,
  };
  localStorage.setItem(key, JSON.stringify(cacheEntry));
}

function loadCachedUserData(username: string) {
  const cached = localStorage.getItem(key);
  if (!cached) return null;
  
  const { timestamp, data } = JSON.parse(cached);
  const ONE_DAY = 24 * 60 * 60 * 1000;
  if (Date.now() - timestamp > ONE_DAY) {
    localStorage.removeItem(key);  // ç¼“å­˜è¿‡æœŸ
    return null;
  }
  return data;
}
```

### 6. æ—¥å¿—ä¿¡æ¯è¿‡å¤š

**é—®é¢˜ä½ç½®**ï¼šå¤šå¤„ `console.log`

**è¯´æ˜**ï¼š
- ç”Ÿäº§ç¯å¢ƒæœ‰å¤§é‡æ—¥å¿—è¾“å‡ºï¼Œå¯èƒ½æš´éœ²å†…éƒ¨é€»è¾‘
- å»ºè®®ç”Ÿäº§ç¯å¢ƒå‡å°‘æ—¥å¿—

**æ”¹è¿›å»ºè®®**ï¼š
```typescript
// åˆ›å»ºæ—¥å¿—å·¥å…·
const log = import.meta.env.DEV ? console.log.bind(console) : () => {};
const warn = import.meta.env.DEV ? console.warn.bind(console) : () => {};
```

---

## ğŸ› ï¸ å…¶ä»–ä¼˜åŒ–å»ºè®®

### 7. æ·»åŠ è¯·æ±‚é€Ÿç‡é™åˆ¶

ä½¿ç”¨ Vercel KV æˆ– Upstash å®ç°ç®€å•é€Ÿç‡é™åˆ¶ï¼š

```typescript
import { Ratelimit } from '@upstash/ratelimit';
import { kv } from '@vercel/kv';

const ratelimit = new Ratelimit({
  redis: kv,
  limiter: Ratelimit.slidingWindow(10, '1 m'),  // æ¯åˆ†é’Ÿ10æ¬¡
});

// åœ¨ handler å¼€å¤´
const identifier = req.headers['x-forwarded-for'] || 'anonymous';
const { success, remaining } = await ratelimit.limit(identifier);
if (!success) {
  return res.status(429).json({ error: 'Too many requests' });
}
```

### 8. é”™è¯¯ä¿¡æ¯è„±æ•

**é—®é¢˜**ï¼šé”™è¯¯ä¿¡æ¯å¯èƒ½æš´éœ²å†…éƒ¨ç»†èŠ‚

```typescript
// api/llm.ts:75
throw new Error(`${config.model} è°ƒç”¨å¤±è´¥ (${response.status}): ${error}`);
// ğŸš¨ å¯èƒ½æš´éœ²æ¨¡å‹åç§°å’Œè¯¦ç»†é”™è¯¯
```

**å»ºè®®**ï¼š
```typescript
console.error(`[LLM] ${config.model} è°ƒç”¨å¤±è´¥:`, error);  // ä»…æ—¥å¿—
throw new Error('AI æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•');  // è¿”å›é€šç”¨é”™è¯¯
```

### 9. æ·»åŠ å®‰å…¨å“åº”å¤´

åœ¨ `vercel.json` ä¸­æ·»åŠ ï¼š

```json
{
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        { "key": "X-Content-Type-Options", "value": "nosniff" },
        { "key": "X-Frame-Options", "value": "DENY" },
        { "key": "X-XSS-Protection", "value": "1; mode=block" },
        { "key": "Referrer-Policy", "value": "strict-origin-when-cross-origin" }
      ]
    }
  ]
}
```

---

## âœ… å·²æœ‰çš„è‰¯å¥½å®è·µ

1. **API Key å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡**ï¼š`.env` è¢« `.gitignore` æ’é™¤
2. **ç”Ÿäº§ç¯å¢ƒèµ°åç«¯ä»£ç†**ï¼šä¸æš´éœ² API Key åˆ°å‰ç«¯
3. **å¤šæ¨¡å‹ Fallback**ï¼šæé«˜å¯ç”¨æ€§
4. **æ•°æ®å»é‡**ï¼šé˜²æ­¢ API åˆ†é¡µé—®é¢˜
5. **MAX_PAGES é™åˆ¶**ï¼šé˜²æ­¢æ— é™å¾ªç¯

---

## ğŸ“ ä¿®å¤ä¼˜å…ˆçº§æ€»ç»“

| ä¼˜å…ˆçº§ | é—®é¢˜ | ä¿®å¤éš¾åº¦ |
|--------|------|----------|
| ğŸ”´ P0 | LLM API ä»£ç†æ— è®¿é—®é™åˆ¶ | ä¸­ï¼ˆéœ€è¦æ·»åŠ  Origin/Referer æ£€æŸ¥ï¼‰ |
| ğŸ”´ P0 | æ·»åŠ é€Ÿç‡é™åˆ¶ | ä¸­ï¼ˆéœ€è¦å¼•å…¥ Upstash/KVï¼‰ |
| ğŸŸ¡ P1 | Watcha ä»£ç†è·¯å¾„ç™½åå• | ä½ |
| ğŸŸ¡ P1 | è¾“å…¥å‚æ•°éªŒè¯ | ä½ |
| ğŸŸ¢ P2 | æœ¬åœ°ç¼“å­˜è¿‡æœŸæœºåˆ¶ | ä½ |
| ğŸŸ¢ P2 | æ—¥å¿—è„±æ• | ä½ |
| ğŸŸ¢ P2 | æ·»åŠ å®‰å…¨å“åº”å¤´ | ä½ |

---

*æŠ¥å‘Šç”Ÿæˆè€…ï¼šAntigravity AI*

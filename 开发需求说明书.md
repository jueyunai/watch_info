# 猹评导出工具 - 开发需求说明书

> 本文档供开发实习生在其他平台复刻使用，包含核心功能、API 接口、数据结构和常见坑点。

## 一、产品概述

**产品名称**：猹评导出工具  
**功能定位**：从观猹平台（watcha.cn）获取用户的所有猹评数据，支持在线查看、时间筛选和导出为 TXT 文件。

## 二、核心功能

### 2.1 输入个人主页地址 → 获取用户ID

**用户输入**：`https://watcha.cn/@zhiyun`  
**系统处理**：
1. 从 URL 中提取用户名 `zhiyun`
2. 调用 API 获取用户 ID

### 2.2 分页获取全部猹评

- 每页最多 20 条数据
- 自动翻页直到获取完毕
- 显示加载进度

### 2.3 数据展示

- 产品名称
- 评论时间（本地格式）
- 评论内容（纯文本）

### 2.4 时间筛选

- 下拉框选择月份
- 快捷选项：最近 3 个月（如当前 12 月，显示 9月、10月、11月）
- 筛选结果实时更新

### 2.5 导出 TXT

- 导出当前筛选后的数据
- 文件名：`个人猹评.txt`

---

## 三、API 接口说明

### 3.1 获取用户信息

```
GET https://watcha.cn/api/v2/users/{username}
```

**请求示例**：
```
GET https://watcha.cn/api/v2/users/zhiyun
```

**响应示例**：
```json
{
  "statusCode": 200,
  "data": {
    "id": 10005265,
    "nickname": "志云",
    "username": "zhiyun",
    "review_count": 84
  }
}
```

**关键字段**：
- `data.id` - 用户 ID（后续请求需要）
- `data.review_count` - 猹评总数（用于显示进度）

---

### 3.2 获取猹评列表

```
GET https://watcha.cn/api/v2/users/{userId}/reviews?_user_id={userId}&skip={offset}&limit=20
```

**请求示例**：
```
GET https://watcha.cn/api/v2/users/10005265/reviews?_user_id=10005265&skip=0&limit=20
```

**分页参数**：
- `skip` - 跳过的条数（第一页=0，第二页=20，第三页=40...）
- `limit` - 每页条数（固定 20）

**响应示例**：
```json
{
  "statusCode": 200,
  "data": {
    "total": 84,
    "skip": 0,
    "limit": 20,
    "count": 20,
    "items": [
      {
        "id": 10907,
        "product": {
          "name": "Kuse"
        },
        "content": {
          "type": "doc",
          "content": [...]
        },
        "update_at": "2025-11-29T09:59:40.159Z"
      }
    ]
  }
}
```

**关键字段**：
- `data.total` - 总条数
- `data.items` - 猹评数组
- `data.items[].product.name` - 产品名称
- `data.items[].update_at` - 更新时间（ISO 8601 格式）
- `data.items[].content` - 评论内容（嵌套结构，需解析）

---

## 四、⚠️ 重点难点和坑点

### 4.1 跨域问题（CORS）- 最大的坑！

**问题**：浏览器直接请求 `https://watcha.cn/api/...` 会被 CORS 策略阻止。

**解决方案**：

**方案 A：开发环境使用代理**
```javascript
// vite.config.js 或 webpack.config.js
{
  server: {
    proxy: {
      '/api': {
        target: 'https://watcha.cn',
        changeOrigin: true
      }
    }
  }
}
```
代码中请求 `/api/v2/users/...`，代理会转发到 `https://watcha.cn/api/v2/users/...`

**方案 B：后端转发**
自己写一个后端接口转发请求。

**方案 C：浏览器插件**
如果是浏览器插件，可以在 manifest 中声明权限。

---

### 4.2 评论内容解析 - 嵌套结构

**问题**：`content` 字段不是纯文本，而是类似 ProseMirror/TipTap 的嵌套 JSON 结构。

**原始数据结构**：
```json
{
  "type": "doc",
  "content": [
    {
      "type": "paragraph",
      "content": [
        { "type": "text", "text": "创意很好，但实现出来～ " },
        { "type": "text", "text": "成本敏感性用户很难接受", "marks": [{"type": "bold"}] }
      ]
    },
    { "type": "paragraph" },
    {
      "type": "paragraph", 
      "content": [
        { "type": "text", "text": "1、认真看了产品介绍视频..." }
      ]
    }
  ]
}
```

**解析逻辑**（伪代码）：
```javascript
function parseContent(node) {
  let result = '';
  
  // 如果有 text 字段，直接取出
  if (node.text) {
    result += node.text;
  }
  
  // 如果有 content 数组，递归处理
  if (node.content && Array.isArray(node.content)) {
    for (let i = 0; i < node.content.length; i++) {
      const child = node.content[i];
      result += parseContent(child);
      
      // paragraph 节点后加换行（除了最后一个）
      if (child.type === 'paragraph' && i < node.content.length - 1) {
        result += '\n';
      }
    }
  }
  
  return result;
}
```

**注意**：
- `marks` 字段（如 bold、italic）可以忽略，只取纯文本
- 空的 `paragraph` 节点表示空行
- `LineBreak` 类型节点需要加换行符

---

### 4.3 分页逻辑

**判断是否还有下一页**：
```javascript
// 如果返回的条数 < 请求的 limit，说明没有更多数据了
if (response.items.length < 20) {
  // 停止请求
} else {
  // 继续请求下一页，skip += 20
}
```

**不要用 total 判断**：虽然有 total 字段，但用 items.length 判断更可靠。

---

### 4.4 时间格式转换

**原始格式**：`2025-11-29T09:59:40.159Z`（UTC 时间）  
**显示格式**：`2025-11-29 17:59`（本地时间）

```javascript
function formatDateTime(isoString) {
  const date = new Date(isoString);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const hours = String(date.getHours()).padStart(2, '0');
  const minutes = String(date.getMinutes()).padStart(2, '0');
  return `${year}-${month}-${day} ${hours}:${minutes}`;
}
```

**注意**：`new Date()` 会自动转换为本地时区。

---

### 4.5 月份筛选边界

**生成最近 3 个月**：
```javascript
function getRecentMonths(count = 3) {
  const now = new Date();
  const months = [];
  
  for (let i = 1; i <= count; i++) {
    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
    months.push({
      year: date.getFullYear(),
      month: date.getMonth() + 1,  // 注意：getMonth() 是 0-11
      label: `${String(date.getFullYear()).slice(2)}年${date.getMonth() + 1}月`
    });
  }
  
  return months;
}
```

**月份范围**：
- 开始：该月 1 日 00:00:00.000
- 结束：该月最后一天 23:59:59.999

```javascript
// 获取某月最后一天
const lastDay = new Date(year, month, 0).getDate();  // month 是 1-12
```

---

### 4.6 URL 解析

**合法格式**：
- `https://watcha.cn/@zhiyun`
- `http://watcha.cn/@zhiyun`
- `https://watcha.cn/@zhiyun/`（带斜杠）

**正则表达式**：
```javascript
const pattern = /^https?:\/\/watcha\.cn\/@([a-zA-Z0-9_-]+)\/?$/;
const match = url.match(pattern);
if (match) {
  const username = match[1];  // 'zhiyun'
}
```

---

## 五、数据流程图

```
用户输入 URL
    ↓
解析 URL 提取 username
    ↓
GET /api/v2/users/{username} → 获取 userId
    ↓
循环: GET /api/v2/users/{userId}/reviews?skip=0,20,40...
    ↓
解析 content 字段 → 提取纯文本
    ↓
按时间倒序排列
    ↓
渲染列表 / 筛选 / 导出
```

---

## 六、UI 要素

1. **输入框**：个人主页地址
2. **按钮**：获取猹评
3. **加载状态**：显示进度（已获取 X / 总共 Y 条）
4. **错误提示**：URL 格式错误、用户不存在、网络错误
5. **统计信息**：共 X 条猹评（筛选后 Y 条）
6. **下拉框**：时间筛选（全部 / 最近3个月）
7. **导出按钮**：导出 TXT
8. **列表**：产品名称 | 时间 | 内容

---

## 七、导出格式

```
猹评导出
导出时间：2025-12-01 21:45
共 28 条猹评

==================================================

1. 【Kuse】
时间：2025-11-29 17:59
内容：创意很好，但实现出来～ 成本敏感性用户很难接受，交互体验不顺畅
    1、认真看了产品介绍视频...

==================================================

2. 【Seko】
时间：2025-11-29 13:23
内容：图生视频过渡期方案，且性价比不高...
```

---

## 八、技术选型建议

| 平台 | 推荐方案 |
|------|----------|
| Web（纯前端） | React/Vue + Vite，需配置代理 |
| Web（全栈） | Next.js/Nuxt.js，API 路由转发 |
| 小程序 | 微信云开发，云函数转发请求 |
| 桌面应用 | Electron/Tauri，无跨域问题 |
| 浏览器插件 | Chrome Extension，manifest 声明权限 |

---

## 九、测试用例

| 场景 | 输入 | 预期结果 |
|------|------|----------|
| 正常获取 | `https://watcha.cn/@zhiyun` | 显示 84 条猹评 |
| URL 格式错误 | `watcha.cn/@zhiyun` | 提示格式错误 |
| 用户不存在 | `https://watcha.cn/@notexist123456` | 提示用户不存在 |
| 筛选 11 月 | 选择"25年11月" | 显示 28 条 |
| 导出 | 点击导出 | 下载 TXT 文件 |

---

## 十、常见问题 FAQ

**Q: 为什么请求失败显示 "Failed to fetch"？**  
A: 跨域问题，需要配置代理或后端转发。

**Q: 为什么评论内容显示不完整或格式错乱？**  
A: content 字段解析不正确，需要递归处理嵌套结构。

**Q: 为什么时间显示和网站上不一样？**  
A: 时区问题，API 返回的是 UTC 时间，需要转换为本地时间。

**Q: 为什么筛选后数量不对？**  
A: 检查月份边界计算，注意 JavaScript 的 getMonth() 返回 0-11。

---

*文档版本：v1.0*  
*最后更新：2025-12-01*
